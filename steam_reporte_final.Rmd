---
title: "Sistemas de Recomendación Implícita para videojuegos de plataforma Steam"
author: 
- Carlos Bautista
- Mario Heredia
- Miguel Reyes
output:
  html_document: default
---


# Examen final Métodos Analíticos. 

### Maestría en Ciencia de Datos ITAM {.tabset .tabset-fade .tabset-pills}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Introducción

# Trabajo previo (opcional)



# Base de datos

Los datos utilizados se obtuvieron de la base *Condensing Steam: Distilling the Diversity of Gamer Behavior*, que agrupa información histórica de 108.7 millones de usuarios recolectados en 2014 de la plataforma de videojuegos Steam, con 716 millones de juegos y hasta 1.1 millones de años en horas jugadas.

La base original está compuesta de 11 tablas de datos que contienen información diversa sobre los usuarios y sus atributos (id, juegos jugados, horas jugadas, información geográfica, información sobre sus "amigos", entre otros.), así como de los juegos y sus características (género, desarrollador, editor, etc.).

Para el presente proyecto, se utilizó un subconjunto de "Condensing Steam" tomando de manera aleatoria 800 mil usuarios contenidos en la base, QUE SE CREÓ DE LA SIGUIENTE FORMA 


(MH)



El conjunto de datos resultante está compuesto de 7.2 millones de observaciones y 3 variables que son las que se utilizarán para construir el sistema de recomendación implícito:

 - `steamid`: el identificador del usuario de la plataforma
 - `app_name`: nombre del videojuego
 - `playtime_forever`: minutos totales que el usuario ha utilizado el videojuego.
 
Exploramos algunos datos de la tabla:

```{r}
cat_def <- read_rds('cache/cat_apps_def.rds')
cat_limpio <- read_rds('cache/cat_apps_limpio.rds')
dta_clean <- read_rds('cache/data_clean.rds')
head(dta_clean)
```

Del total de los usuarios recolectados, se eliminaron aquellos que estaban registrados en la plataforma y tenían al menos algún videojuego registrado pero sin haberlo jugado. En ese sentido, se tienen 732,759 usuarios diferentes que interactúan con 4,133 videojuegos.

```{r}
dim(dta_clean)
length(unique(dta_clean$steamid))
length(unique(dta_clean$app_name))
```

Respecto al número de minutos jugadas (playtime_forever), el resumen estadístico puede observarse a continuación:

```{r}
summary(dta_clean$playtime_forever)
```

## Split en entrenamiento y validación

Los datos se dividen en un conjunto de entrenamiento que nos servirá para construir el modelo y otro de validación con el que evaluaremos las recomendaciones sugeridas.

Para ello, se extraen de manera aleatoria 50% de los usuarios de la plataforma (`steamid`), y después se extraen de manera aleatoria el 50% de los videojuegos (`app_name`). Se genera un nuevo conjunto de datos con la intersección de ambos subconjuntos que corresponde al conjunto de validación, mientras que el conjunto de entrenamiento se forma con los datos restantes.

De esta forma, los datos de validación corresponden al 25% del total de los datos, que equivalen a 1.78 millones de observaciones, y los de entrenamiento al 75%, con 5.42 millones de observaciones.

```{r}
dta_train <- read_rds('cache/dta_train.rds')
dta_validation <- read_rds('cache/dta_validation.rds')
dim(dta_train)
dim(dta_validation)
```

Despúes de la separación, el conjunto de entrenamiento contiene 652,117 usuarios distintos y 4,115 videojuegos, mientras que el de validación tiene 270,827 usuarios y 2,038 videojuegos.

```{r}
length(unique(dta_train$steamid))
length(unique(dta_train$app_name))
length(unique(dta_validation$steamid))
length(unique(dta_validation$app_name))
```



# Metodología

Sistema de recomendación busca resolver el problema de "predecir la respuesta de personas a estímulos a los que no han sido expuestos, basados en respuesta a otros estímulos de esta y quizá otras personas similares". 

El más común es el explícito, donde el usuario otorga una calificación al producto (típicamente en una escala del 1 a 5 estrellas), para lo cual se cuentan con modelos de recomendación y métricas de evaluación (RMSE) bien definidas a partir de dichas calificaciones explícitas.

Los sistemas de recomendación implícitos se refieren a contextos donde no se tiene una calificación/evaluación del producto explícitamente definida por el usuario, pero se tienen variables de acciones del usuario que reflejan la preferencia o popularidad del producto y que, en muchos casos, resultan más informativos que la calificación directa otorgoda por el usuario.

Nuestro sistema de recomendación se construye utilizando las horas jugadas por un usuario para cada videojuego.

## Modelo 

Para este trabajo consideramos el índice $u,v$ para distinguir usuarios; los artículos están determinados por los subíndices $i,j$. De tal forma que podemos relacionar a los usuarios y los artículos mediante la relación $r_{u,i}$.  Esta relación representa la frecuencia de acciones sobre un artículo, por ejemplo, el número de compras en un sitio web, el número de veces que oprimimos la tecla "favoritos", clics que damos a un producto en especial o el tiempo para ver / escuchar video / audio. Es decir, es una medida implícita para el usuario $u$ y el artículo $i$. $r_{u,i}$lo entendemos, en el contexto de recomendación implícita, como las observaciones que se tienen. Hay que notar que en la recomendación explícita estos valores serían llamados los "ratings" otorgados a los artículos. Importante reiterar que aquí le llamamos observaciones.


Para poner en contexto, $r_{u,i}$ puede indicar el número de ocasiones que el individuo $u$ adquiere el artículo $i$. O bien el tiempo que $u$ navega en el sitio web de $i$.En nuestro ejercicio, $r_{u,i}$ indica el tiempo que un individuo dedica a jugar un videojuego en específico.

Para nuestro modelo, consideramos la variable binaria $p_{u,i}$ que nos indica la preferencia del usuario $u$ por un artículo $i$. 
$$
P_{u,i} =\left\{ \begin{array}{rcl}
 1\;\;si\;\;\;\; r_{u,i}\;>\; 0 \\ 0\;\;si\;\;\;\; r_{u,i}\;=\;0 
\end{array}\right.
$$
$p_{u,i}\;=\;1$ nos indica que el usuario $u$ consume el artículo $i$, donde $r_{u,i} > 0$. Es decir, las observaciones entre el usuario y el artículo son positivas. 

$p_{u,i}\;=\;0$ nos indica que el usuario $u$ no consume el bien $i$,donde $r_{u,i} = 0$. Es decir, no hay observaciones entre el usuario y el artículo. 

En este sentido, si $p_{u,i}\;=\;0$, nos haría creer que el individuo $u$ no tiene preferencia por ese bien. Si sólo utilizamos $p_{u,i}$ se pensará que  el usuario actúa con un comportamiento binario. Si compra un producto, es porque le gusta el producto; de lo contrario, significa que al usuario no le gusta el producto. Hay que tener cuidado con esta  apreciación porque la realidad no es tan simple, la compra de un artículo por parte de un usuario no significa necesariamente que le guste al usuario, éste puede ser comprado como un regalo.


Para corregir este sesgo binario, tenemos que considerar que nuestras creencias sobre las preferencias están asociadas con niveles de confianza muy variables, no son binarias. En primer lugar, por la naturaleza de los datos, cuando $p_{u,i}\;=\;0$ se asocia con una confianza baja, pero no  tomar ninguna acción positiva sobre un elemento puede deberse a muchas otras razones más allá de que no le guste. Aquí hay que tener en cuenta que el usuario puede desconocer la existencia de algún bien, en nuestro caso, de un videojuego. Incluso puede no consumirlo por el precio o disponibilidad.

Los individuos tenemos distintos niveles de confianza entre los bienes que se consumen, incluso entre los elementos que son preferidos por el usuario. En general si $r_{u,i}$ crece, es un indicador que el usuario tiene mayor prefrencia por el artículo.

Para saber qué tanto valor debemos darle a la preferencia, necesitamos modelar un nivel de confianza para mostrar que los usuarios prefieren un determinado producto. La confianza la medimos de la siguiente forma: 
$$c_{ui} = 1+ \alpha r_{ui},$$
Así obtenemos una confianza mínima en $p_{u,i}$

$C_{u,i}$mide la confianza en la observación $p_{u,i}$.

$\alpha$ es un parámetro constante de la tasa de incremento de la variable. Es un coeficiente de confianza que aumenta mientras observamos más evidencia del sesgo positivo.
 
Asumimos que las preferencias son el producto punto de $p_{u,i}\;=\;x_u^Ty_i$. Estos vectores corresponden al usuario $u$ y al artículo $i$
 
Estos dos vectores son referentes a los usuarios y los productos, lo que deseamos es compararlos directamente. Esta técnica es similar a la factorización de matrices que se realiza en recomendación explícita, pero con dos distinciones importantes: a) Necesitamos tomar en cuenta la variedad de los niveles de confianza; b) La optimización debe considerar todos los posibles pares de $u,i$, no solamente los observados. De acuerdo con esto, la función de pérdida que debe ser minimizada se ve de la siguiente forma: 
$$ \min_{x*,y*}\sum_{u,i} C_{u,i}(p_{u,i}-x_u^Ty_i)^2 \;+\; \lambda(\sum_{u}\|x_u\|^2\;+\;\sum_{i}\|y_u\|^2)$$
Donde $\lambda(\sum_{u}\|x_u\|^2\;+\;\sum_{i}\|y_u\|^2)$ es un parámetro de regularización y se hace una normalización para evitar el sobreajuste. $\lambda$ es uno de los parámetros que hay que ajustar.

La función de pérdida que queremos minimizar contiene $m.n$ términos, donde $m$ es el número de usuarios y $n$ es el número de artículos. Esto implica que tenemos un número grande de términos que no podemos optimizar directamente con técnicas de optimización comunes como descenso en gradiente estocástico. Para optimizar utilizamos el algoritmo de Mínimos Cuadrados Alternados (ALS)

## Alternating Least Squares (ALS)

ALS es la abreviatura de alternar mínimos cuadrados. Se refiere a un algoritmo de recomendación que utiliza las calificaciones de todos los usuarios observados para inferir las preferencias de cada usuario y recomendar productos adecuados para el usuario.

Cuando hablamos de recomendación implícita, es un algoritmo capaz de identificar artículos similares y hacer recomendaciones para los usuarios.


## Evaluación

La evaluación para modelos implícitos no es tan simple como en el caso explícito, pues no estamos modelando
directamente los valores observados $r_{u,i}$.  

Lo recomendable para cada usuario $i$, es generar un rango de los artículos de mayor a menor valor de $\hat{p}_{ui} = u_iv_j^t$ (juegos), y calcular

$$
\overline{rank} = \frac{\sum_{u,i} r_{ui}^t\;rank_{ui}}{\sum_{u,i}\;r_{ui}^t}
$$
Valores bajos de $\overline{rank}$ son más deseables, pues ellos indican que el orden de los juegos más utilizados están más cerca de la parte superior de la lista. 

Podemos decir que $\overline{rank} \;=\;0$ para el mejor juego y $\overline{rank} \;=\;1$ para el peor. Los valores más bajos son obtenidos si los usuarios interactúan más con artículos que están encima en el ranking.

NOTA. cambiar lado derecho de la ecuación a percentil u,i en lugar de rank u,i y explicar.

PREPROCESAMIENTO DE DATOS (DIVIDIR ENTRE 60, NUMÉRICOS, ETC.)

NORMALIZACIÓN. SE REENUMERARON LOS IDS DE USUARIOS Y JUEGOS, PARA UTILIZAR EN SPARK.

Consideraciones sobre evaluación


# Resultados

SISTEMA DE RECOMENDACIÓN

Se corrieron XX configuraciones de modelos (y tabla)

El mejor modelo: 

- Lamda es el que más afecta los resultados. el rank si afecta pero no mucho. El valor de alpha fue el mejor 1 (default).

- La mejor configuración fue lamda 150, rank 80, y alpha 1.

- Gráfica rank vs count (cero donde mejor lo hace), por lo tanto esperaríamos mayor densidad en valores cercanos a cero.

- Para un usuario particular (id = 15), el que más jugó le dio una recomendación alta. Otros ejemplos donde usuario jugó poquito y le dio

VALOR DE 0.17 y explicación

RECOMENDACIONES EXITOSAS DE ARTÍCULOS ESPECÍFICOS (tablas)

ejemplo de FALLOS (tablas)


# Conclusiones

VENTAJA DE SISTEMA DE RECOMENDACIÓN IMPLICITO. puede ser más informativo


CONCLUSIONES SOBRE RESULTADOS

notas. 



EFECTOS OBSERVADOS DE PARÁMETROS

DIFERENCIAS ESPECÍFICAS SOBRE RECOMENDACIÓN DE VIDEOJUEGOS Y PELICULAS (CONTEXTO)
Ver paper.
Diferentes inherentes desde la recolección de los datos en Steam vs otras plataformas. QUE ES STEAM, plataforma que instalas y para jugar necesitas iniciar sesión, te monitorea toda tu actividad, etc.


FUTURAS LINEAS DE INVESTIGACIÓN (RETOS PARA EL EQUIPO)
En general el tamaño de datos, limitaciones de cómputo (más usuarios, más juegos, etc.)





**PENDIENTES**

CBP: INCORPORAR NOTAS DE MARIO Y AFINAR ESTILO Y REDACCIÓN

MRR: INTRODUCCIÓN Y COMENTARIOS A SECCIÓN DE MODELO

MHT: RESULTADOS

TODOS: IDEAS PARA CONCLUSIONES
